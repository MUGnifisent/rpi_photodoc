{% extends "base.html" %}
{% block title %}Photo Gallery{% endblock %}

{% block head %}
{{ super() }}
<style>
    .photo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 400px));
        gap: 2rem;
        justify-content: start;
    }
    .photo-card {
        background: #232323;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
        border: 1px solid #292929;
        transition: box-shadow 0.2s;
        min-height: 350px;
    }
    .photo-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.18);
    }
    .photo-card .card-image {
        width: 100%;
        aspect-ratio: 4/3;
        background: #181818;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .photo-card .card-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        background: #222;
    }
    .select-photo-checkbox {
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 2;
        margin: 0;
        opacity: 0.9;
        background: #fff;
        border-radius: 3px;
        width: 22px;
        height: 22px;
        border: 2px solid #ff9800;
        accent-color: #ff9800;
    }
    .photo-card .card-content {
        padding: 1rem 1rem 0.5rem 1rem;
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        min-height: 120px;
    }
    .photo-card .card-content .title {
        font-size: 1.05rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 0.35rem;
        word-break: break-all;
        display: block;
    }
    .photo-card .card-content .subtitle {
        font-size: 0.85rem;
        color: #bbb;
        margin-bottom: 0.5rem;
        margin-top: 0;
        display: block;
    }
    .photo-card .card-content .content {
        font-size: 0.95rem;
        color: #e0e0e0;
        margin-top: 0.2rem;
        overflow: hidden;
        position: relative;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        line-clamp: 3;
        max-height: 4.5em;
        white-space: pre-line;
        text-overflow: ellipsis;
        flex-grow: 1;
    }
    .photo-card .card-content .content::after {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 2em;
        background: linear-gradient(180deg, rgba(35,35,35,0) 0%, #232323 100%);
        pointer-events: none;
    }
    .photo-card .card-actions {
        padding: 0.5rem 1rem 1rem 1rem;
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0;
    }
    .create-doc-actions {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: #1e1e1e;
        border: 1px solid #2c2c2c;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .create-doc-actions .field {
        flex-grow: 1;
        margin-bottom: 0 !important;
    }
    .doc-list {
        margin-top: 2.5rem;
    }
    .doc-list .doc-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #232323;
        border-radius: 8px;
        border: 1px solid #292929;
        padding: 1.2rem 1.5rem;
        margin-bottom: 1.2rem;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        transition: box-shadow 0.2s;
    }
    .doc-list .doc-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.13);
    }
    .doc-list .doc-info {
        flex: 1 1 auto;
        min-width: 0;
    }
    .doc-list .doc-title {
        font-size: 1.15rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 0.2rem;
        word-break: break-all;
    }
    .doc-list .doc-meta {
        font-size: 0.92rem;
        color: #bbb;
        margin-bottom: 0.1rem;
    }
    .doc-list .doc-actions {
        margin-left: 1.5rem;
        flex-shrink: 0;
        display: flex;
        gap: 0.5rem;
    }
    .doc-list .button {
        min-width: 80px;
    }
    
    /* Confirmation Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .modal.is-active {
        display: block;
    }
    .modal-content {
        background-color: #1e1e1e;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #2c2c2c;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
        color: #e0e0e0;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .modal-header h3 {
        margin: 0;
        color: #ff6600;
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #888;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-close:hover {
        color: #fff;
    }
    .modal-body {
        margin-bottom: 1.5rem;
        line-height: 1.5;
    }
    .modal-footer {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }
</style>
{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <div class="level mb-5">
            <div class="level-left">
                <div>
                    <h1 class="title is-2">My Photos</h1>
                    <p class="subtitle is-5 has-text-grey-light">Browse and select photos to create documents.</p>
                </div>
            </div>
            <div class="level-right">
                <a href="{{ url_for('main.upload_page') }}" class="button is-primary is-medium">
                    <span class="icon"><i class="fas fa-plus"></i></span>
                    <span>Upload New Photo</span>
                </a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="notification is-{{ 'success' if category == 'success' else 'danger' }} is-light is-small mb-4">
                        <button class="delete is-small"></button>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Create Document Actions -->
        <div class="create-doc-actions" id="create-doc-actions" style="display: none;">
            <div class="field">
                <label class="label" for="new_doc_name">New Document Name (Optional)</label>
                <div class="control">
                    <input class="input" type="text" id="new_doc_name" placeholder="e.g., Project Report">
                </div>
            </div>
            <div class="control">
                <label class="label">&nbsp;</label>
                <button class="button is-link" id="create-doc-btn" disabled>
                    <span class="icon"><i class="fas fa-file-alt"></i></span>
                    <span>Create Document (<span id="selected-photo-count">0</span>)</span>
                </button>
            </div>
        </div>

        {% if photos %}
            <div class="photo-grid">
                {% for photo in photos %}
                    <div class="photo-card" data-photo-id="{{ photo.id }}">
                        <div class="card-image">
                            <img src="{{ url_for('uploaded_file', filename=photo.image_filename) }}" alt="Photo {{ photo.id }}" onerror="this.src='/static/img/image_placeholder.png'">
                            <input type="checkbox" class="select-photo-checkbox" data-photo-id="{{ photo.id }}" aria-label="Select photo">
                        </div>
                        <div class="card-content">
                            <div class="title">{{ photo.image_filename | truncate(40) }}</div>
                            <div class="subtitle">Uploaded: {{ photo.created_at | format_datetime }}</div>
                            <div class="content">{{ photo.edited_text }}</div>
                        </div>
                        <div class="card-actions">
                            <button class="button is-info is-small photo-usage-btn" data-photo-id="{{ photo.id }}">
                                <span class="icon"><i class="fas fa-info-circle"></i></span>
                                <span>Usage</span>
                            </button>
                            <button class="button is-danger is-small photo-delete-btn" data-photo-id="{{ photo.id }}" data-filename="{{ photo.image_filename }}">
                                <span class="icon"><i class="fas fa-trash"></i></span>
                                <span>Delete</span>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="box no-documents">
                <p class="title is-4"><i class="fas fa-folder-open fa-2x mb-3"></i><br>No photos yet!</p>
                <p class="subtitle is-6 has-text-grey-light">Upload a photo to get started.</p>
                <a href="{{ url_for('main.upload_page') }}" class="button is-primary is-medium mt-4">
                    <span class="icon"><i class="fas fa-upload"></i></span>
                    <span>Upload First Photo</span>
                </a>
            </div>
        {% endif %}

        <!-- List of Documents -->
        <div class="doc-list">
            <h2 class="title is-4">My Documents</h2>
            {% if documents %}
                {% for doc in documents %}
                    <div class="doc-card" data-doc-id="{{ doc.id }}">
                        <div class="doc-info">
                            <div class="doc-title">
                                <a href="{{ url_for('main.document_view', doc_id=doc.id) }}">{{ doc.name | truncate(60) }}</a>
                            </div>
                            <div class="doc-meta">
                                {{ doc.photo_ids | length }} page(s) &bull; Updated: {{ doc.updated_at | format_datetime }}
                            </div>
                        </div>
                        <div class="doc-actions">
                            <a href="{{ url_for('main.document_view', doc_id=doc.id) }}" class="button is-link is-small">
                                <span class="icon"><i class="fas fa-eye"></i></span>
                                <span>View</span>
                            </a>
                            <button class="button is-danger is-small doc-delete-btn" data-doc-id="{{ doc.id }}" data-doc-name="{{ doc.name }}">
                                <span class="icon"><i class="fas fa-trash"></i></span>
                                <span>Delete</span>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="has-text-grey-light">No documents yet. Select photos above and create your first document!</p>
            {% endif %}
        </div>
    </div>
</section>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Confirm Action</h3>
            <button class="modal-close" id="modalClose">&times;</button>
        </div>
        <div class="modal-body">
            <p id="modalMessage">Are you sure you want to proceed?</p>
        </div>
        <div class="modal-footer">
            <button class="button is-light" id="modalCancel">Cancel</button>
            <button class="button is-danger" id="modalConfirm">Confirm</button>
        </div>
    </div>
</div>

<!-- Photo Usage Modal -->
<div id="photoUsageModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Photo Usage Information</h3>
            <button class="modal-close" id="usageModalClose">&times;</button>
        </div>
        <div class="modal-body" id="usageModalBody">
            <p>Loading...</p>
        </div>
        <div class="modal-footer">
            <button class="button is-light" id="usageModalOk">OK</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const checkboxes = document.querySelectorAll('.select-photo-checkbox');
    const createDocActions = document.getElementById('create-doc-actions');
    const createDocBtn = document.getElementById('create-doc-btn');
    const selectedPhotoCountSpan = document.getElementById('selected-photo-count');
    const newDocNameInput = document.getElementById('new_doc_name');

    // Modal elements
    const confirmationModal = document.getElementById('confirmationModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalClose = document.getElementById('modalClose');
    const modalCancel = document.getElementById('modalCancel');
    const modalConfirm = document.getElementById('modalConfirm');

    // Photo usage modal elements
    const photoUsageModal = document.getElementById('photoUsageModal');
    const usageModalClose = document.getElementById('usageModalClose');
    const usageModalOk = document.getElementById('usageModalOk');
    const usageModalBody = document.getElementById('usageModalBody');

    let selectedPhotoIds = [];
    let currentAction = null;

    // Update create document button state
    function updateCreateDocButtonState() {
        selectedPhotoIds = Array.from(checkboxes)
                                .filter(cb => cb.checked)
                                .map(cb => cb.dataset.photoId);
        selectedPhotoCountSpan.textContent = selectedPhotoIds.length;
        if (selectedPhotoIds.length >= 1) {
            createDocBtn.disabled = false;
            createDocActions.style.display = 'flex';
        } else {
            createDocBtn.disabled = true;
            createDocActions.style.display = 'none';
        }
    }

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateCreateDocButtonState);
    });

    // Create document functionality
    createDocBtn.addEventListener('click', async () => {
        if (selectedPhotoIds.length < 1) {
            alert('Please select at least one photo to create a document.');
            return;
        }
        const newName = newDocNameInput.value.trim();
        createDocBtn.classList.add('is-loading');
        try {
            const response = await fetch("{{ url_for('main.create_document_route') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    photo_ids: selectedPhotoIds,
                    doc_name: newName
                })
            });
            const result = await response.json();
            if (response.ok && result.new_document_id) {
                window.location.href = "{{ url_for('main.document_view', doc_id='_PLACEHOLDER_') }}".replace('_PLACEHOLDER_', result.new_document_id);
            } else {
                alert(result.error || 'Failed to create document.');
            }
        } catch (error) {
            console.error('Error creating document:', error);
            alert('An error occurred while trying to create the document.');
        } finally {
            createDocBtn.classList.remove('is-loading');
        }
    });

    // Modal functions
    function showModal(title, message, confirmCallback) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        confirmationModal.classList.add('is-active');
        currentAction = confirmCallback;
    }

    function hideModal() {
        confirmationModal.classList.remove('is-active');
        currentAction = null;
    }

    function showPhotoUsageModal(photoId) {
        usageModalBody.innerHTML = '<p>Loading...</p>';
        photoUsageModal.classList.add('is-active');
        
        // Fetch photo usage information
        fetch(`/photo/${photoId}/usage`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    usageModalBody.innerHTML = `<p class="has-text-danger">${data.error}</p>`;
                } else {
                    let html = `<p><strong>Photo:</strong> ${data.filename}</p>`;
                    if (data.usage_count === 0) {
                        html += '<p class="has-text-success">This photo is not used in any documents and can be safely deleted.</p>';
                    } else {
                        html += `<p><strong>Used in ${data.usage_count} document(s):</strong></p><ul>`;
                        data.used_in_documents.forEach(doc => {
                            html += `<li><a href="/document/${doc.id}">${doc.name}</a></li>`;
                        });
                        html += '</ul><p class="has-text-warning">Remove this photo from all documents before deleting it.</p>';
                    }
                    usageModalBody.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error fetching photo usage:', error);
                usageModalBody.innerHTML = '<p class="has-text-danger">Error loading photo usage information.</p>';
            });
    }

    function hidePhotoUsageModal() {
        photoUsageModal.classList.remove('is-active');
    }

    // Modal event listeners
    modalClose.addEventListener('click', hideModal);
    modalCancel.addEventListener('click', hideModal);
    modalConfirm.addEventListener('click', () => {
        if (currentAction) {
            currentAction();
        }
        hideModal();
    });

    usageModalClose.addEventListener('click', hidePhotoUsageModal);
    usageModalOk.addEventListener('click', hidePhotoUsageModal);

    // Close modal when clicking outside
    window.addEventListener('click', (event) => {
        if (event.target === confirmationModal) {
            hideModal();
        }
        if (event.target === photoUsageModal) {
            hidePhotoUsageModal();
        }
    });

    // Photo deletion functionality
    document.querySelectorAll('.photo-delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const photoId = btn.dataset.photoId;
            const filename = btn.dataset.filename;
            
            showModal(
                'Delete Photo',
                `Are you sure you want to permanently delete "${filename}"? This action cannot be undone.`,
                async () => {
                    btn.classList.add('is-loading');
                    try {
                        const response = await fetch(`/photo/${photoId}/delete`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();
                        
                        if (response.ok) {
                            // Remove the photo card from the DOM
                            const photoCard = btn.closest('.photo-card');
                            photoCard.remove();
                            
                            // Show success message
                            showNotification('Photo deleted successfully.', 'success');
                            
                            // Update create doc button state
                            updateCreateDocButtonState();
                        } else {
                            showNotification(result.error || 'Failed to delete photo.', 'danger');
                        }
                    } catch (error) {
                        console.error('Error deleting photo:', error);
                        showNotification('An error occurred while deleting the photo.', 'danger');
                    } finally {
                        btn.classList.remove('is-loading');
                    }
                }
            );
        });
    });

    // Photo usage functionality
    document.querySelectorAll('.photo-usage-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const photoId = btn.dataset.photoId;
            showPhotoUsageModal(photoId);
        });
    });

    // Document deletion functionality
    document.querySelectorAll('.doc-delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const docId = btn.dataset.docId;
            const docName = btn.dataset.docName;
            
            showModal(
                'Delete Document',
                `Are you sure you want to delete the document "${docName}"? This action cannot be undone.`,
                async () => {
                    btn.classList.add('is-loading');
                    try {
                        const response = await fetch(`/document/${docId}/delete`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();
                        
                        if (response.ok) {
                            // Remove the document card from the DOM
                            const docCard = btn.closest('.doc-card');
                            docCard.remove();
                            
                            // Show success message
                            showNotification('Document deleted successfully.', 'success');
                        } else {
                            showNotification(result.error || 'Failed to delete document.', 'danger');
                        }
                    } catch (error) {
                        console.error('Error deleting document:', error);
                        showNotification('An error occurred while deleting the document.', 'danger');
                    } finally {
                        btn.classList.remove('is-loading');
                    }
                }
            );
        });
    });

    // Notification function
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification is-${type} is-light is-small mb-4`;
        notification.innerHTML = `
            <button class="delete is-small"></button>
            ${message}
        `;
        
        // Insert at the top of the container
        const container = document.querySelector('.container');
        const firstElement = container.querySelector('.level') || container.firstElementChild;
        container.insertBefore(notification, firstElement.nextSibling);
        
        // Add delete functionality
        const deleteBtn = notification.querySelector('.delete');
        deleteBtn.addEventListener('click', () => notification.remove());
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    updateCreateDocButtonState();
});
</script>
{% endblock %}