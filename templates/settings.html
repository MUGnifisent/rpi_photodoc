{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='settings.css') }}">
{% endblock %}

{% block content %}
<section class="section">
    <div class="container settings-container">
        <div class="box">
            <h1 class="title is-3 has-text-centered">Settings</h1>
            <p class="subtitle is-6 has-text-centered has-text-grey-light mb-5">Configure your preferences and system settings.</p>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="notification is-{{ 'success' if category == 'success' else 'danger' }} is-light is-small mb-4" id="flash-message-{{ loop.index }}">
                            <button class="delete is-small" onclick="this.parentElement.remove();"></button>
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Settings Tabs -->
            <div class="tabs is-boxed">
                <ul>
                    <li class="is-active" data-tab="user-settings">
                        <a>
                            <span class="icon is-small"><i class="fas fa-user-cog"></i></span>
                            <span>My Preferences</span>
                        </a>
                    </li>
                    <li data-tab="system-settings">
                        <a>
                            <span class="icon is-small"><i class="fas fa-server"></i></span>
                            <span>System Settings</span>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- User Settings Tab -->
            <div id="user-settings" class="tab-content">
                <h2 class="title is-4">Your Preferences</h2>
                
                <!-- Image Enhancement Settings -->
                <div class="box">
                    <h3 class="title is-5">Image Enhancement</h3>
                    <div class="field">
                        <label class="checkbox">
                            <input type="checkbox" id="enhancement-enabled" {{ 'checked' if user_settings.image_enhancement.enabled else '' }}>
                            Enable Image Enhancement
                        </label>
                    </div>
                    
                    <div id="enhancement-options" style="{{ 'display: none;' if not user_settings.image_enhancement.enabled else '' }}">
                        <div class="columns">
                            <div class="column">
                                <div class="field">
                                    <label class="checkbox">
                                        <input type="checkbox" id="denoise-enabled" {{ 'checked' if user_settings.image_enhancement.denoise_enabled else '' }}>
                                        Noise Reduction
                                    </label>
                                </div>
                                <div class="field">
                                    <label class="checkbox">
                                        <input type="checkbox" id="contrast-enabled" {{ 'checked' if user_settings.image_enhancement.contrast_enabled else '' }}>
                                        Contrast Enhancement
                                    </label>
                                </div>
                                <div class="field">
                                    <label class="checkbox">
                                        <input type="checkbox" id="sharpen-enabled" {{ 'checked' if user_settings.image_enhancement.sharpen_enabled else '' }}>
                                        Sharpening
                                    </label>
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="checkbox">
                                        <input type="checkbox" id="color-correction-enabled" {{ 'checked' if user_settings.image_enhancement.color_correction_enabled else '' }}>
                                        Color Correction
                                    </label>
                                </div>
                                <div class="field">
                                    <label class="checkbox">
                                        <input type="checkbox" id="camera-optimal-settings" {{ 'checked' if user_settings.image_enhancement.camera_optimal_settings else '' }}>
                                        Optimal Camera Settings
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Experimental Features -->
                        <div class="field">
                            <h4 class="title is-6">Experimental Features</h4>
                            <div class="notification is-warning is-light">
                                <strong>Warning:</strong> Experimental features may affect performance or quality. Use with caution.
                            </div>
                            
                            <div class="columns">
                                <div class="column">
                                    <div class="field">
                                        <label class="checkbox">
                                            <input type="checkbox" id="experimental-hdr-enabled" {{ 'checked' if user_settings.image_enhancement.experimental_hdr_enabled else '' }}>
                                            HDR (High Dynamic Range)
                                        </label>
                                        <p class="help">Captures multiple exposures for better lighting</p>
                                    </div>
                                </div>
                                <div class="column">
                                    <div class="field">
                                        <label class="checkbox">
                                            <input type="checkbox" id="experimental-stacking-enabled" {{ 'checked' if user_settings.image_enhancement.experimental_stacking_enabled else '' }}>
                                            Image Stacking
                                        </label>
                                        <p class="help">Combines multiple shots to reduce noise</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="field">
                            <button class="button is-link is-small" type="button" onclick="showAdvancedSettings()">
                                <span class="icon"><i class="fas fa-cogs"></i></span>
                                <span>Advanced Settings</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="field is-grouped">
                        <div class="control">
                            <button class="button is-primary" type="button" onclick="saveUserSettings('image_enhancement')">
                                <span class="icon"><i class="fas fa-save"></i></span>
                                <span>Save Enhancement Settings</span>
                            </button>
                        </div>
                        <div class="control">
                            <button class="button is-light" type="button" onclick="resetUserSettings('image_enhancement')">
                                <span class="icon"><i class="fas fa-undo"></i></span>
                                <span>Reset to Defaults</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- OCR Settings -->
                <div class="box">
                    <h3 class="title is-5">OCR Preferences</h3>
                    <div class="field">
                        <label class="label">Preferred OCR Mode</label>
                        <div class="control">
                            <div class="select">
                                <select id="ocr-preferred-mode">
                                    <option value="local" {{ 'selected' if user_settings.ocr.preferred_mode == 'local' else '' }}>Local Processing</option>
                                    <option value="remote" {{ 'selected' if user_settings.ocr.preferred_mode == 'remote' else '' }}>Remote Server</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="field is-grouped">
                        <div class="control">
                            <button class="button is-primary" type="button" onclick="saveUserSettings('ocr')">
                                <span class="icon"><i class="fas fa-save"></i></span>
                                <span>Save OCR Settings</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- UI Settings -->
                <div class="box">
                    <h3 class="title is-5">Interface Preferences</h3>
                    <div class="field">
                        <label class="label">Gallery Sort Order</label>
                        <div class="control">
                            <div class="select">
                                <select id="gallery-sort-order">
                                    <option value="created_desc" {{ 'selected' if user_settings.ui.gallery_sort_order == 'created_desc' else '' }}>Newest First</option>
                                    <option value="created_asc" {{ 'selected' if user_settings.ui.gallery_sort_order == 'created_asc' else '' }}>Oldest First</option>
                                    <option value="name_asc" {{ 'selected' if user_settings.ui.gallery_sort_order == 'name_asc' else '' }}>Name A-Z</option>
                                    <option value="name_desc" {{ 'selected' if user_settings.ui.gallery_sort_order == 'name_desc' else '' }}>Name Z-A</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="field">
                        <label class="label">Items Per Page</label>
                        <div class="control">
                            <div class="select">
                                <select id="items-per-page">
                                    <option value="10" {{ 'selected' if user_settings.ui.items_per_page == 10 else '' }}>10</option>
                                    <option value="20" {{ 'selected' if user_settings.ui.items_per_page == 20 else '' }}>20</option>
                                    <option value="50" {{ 'selected' if user_settings.ui.items_per_page == 50 else '' }}>50</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="field is-grouped">
                        <div class="control">
                            <button class="button is-primary" type="button" onclick="saveUserSettings('ui')">
                                <span class="icon"><i class="fas fa-save"></i></span>
                                <span>Save UI Settings</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Settings Tab -->
            <div id="system-settings" class="tab-content" style="display: none;">
                <h2 class="title is-4">System Configuration</h2>
                <p class="subtitle is-6 has-text-grey">These settings affect all users of the system.</p>
                
                <div class="box">
                    <h3 class="title is-5">LLM Configuration</h3>
                    <div class="field">
                        <label class="label" for="llm_server_url">LLM Server URL</label>
                        <div class="control has-icons-left">
                            <input class="input" type="url" id="llm_server_url" value="{{ system_settings.llm_server_url }}" placeholder="e.g. http://localhost:11434/api/generate">
                            <span class="icon is-small is-left"><i class="fas fa-server"></i></span>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label" for="llm_model_name">LLM Model Name</label>
                        <div class="control has-icons-left">
                            <input class="input" type="text" id="llm_model_name" value="{{ system_settings.llm_model_name }}" placeholder="e.g. llama3.1:8b">
                            <span class="icon is-small is-left"><i class="fas fa-brain"></i></span>
                        </div>
                    </div>
                </div>

                <div class="box">
                    <h3 class="title is-5">OCR Configuration</h3>
                    <div class="field">
                        <label class="label">Default OCR Mode</label>
                        <div class="control">
                            <div class="select">
                                <select id="system_ocr_mode">
                                    <option value="local" {{ 'selected' if system_settings.ocr_mode == 'local' else '' }}>Local Processing</option>
                                    <option value="remote" {{ 'selected' if system_settings.ocr_mode == 'remote' else '' }}>Remote Server</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label" for="ocr_server_url">OCR Server URL</label>
                        <div class="control has-icons-left">
                            <input class="input" type="url" id="ocr_server_url" value="{{ system_settings.ocr_server_url }}" placeholder="e.g. http://localhost:8080/ocr">
                            <span class="icon is-small is-left"><i class="fas fa-eye"></i></span>
                        </div>
                    </div>
                </div>

                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-primary" type="button" onclick="saveSystemSettings()">
                            <span class="icon"><i class="fas fa-save"></i></span>
                            <span>Save System Settings</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Notification placeholder for AJAX responses -->
<div id="notification-placeholder"></div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='settings.js') }}"></script>
{% endblock %}