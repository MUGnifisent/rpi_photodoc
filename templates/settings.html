{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block head %}
<style>
    .settings-container {
        max-width: 800px;
        margin: 3rem auto;
    }
    .prompt-textarea {
        min-height: 150px;
        font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.9em;
        white-space: pre-wrap; /* Ensure whitespace is respected */
    }
    .field label.label {
        font-weight: bold;
        color: #e0e0e0; /* Ensure labels are visible */
    }
    .ocr-server-settings {
        margin-top: 1rem;
        padding: 1rem;
        background-color: #1a1a1a;
        border-radius: 6px;
        border: 1px solid #2c2c2c;
        display: none;
    }
    .ocr-server-settings.visible {
        display: block;
    }
    .ocr-mode-info {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #bbb;
    }
</style>
{% endblock %}

{% block content %}
<!-- The main navbar is inherited from base.html. No need to repeat it here. -->
<!-- We just need to ensure the active state is correctly handled in base.html for this page -->

<section class="section">
    <div class="container settings-container">
        <div class="box">
            <h1 class="title is-3 has-text-centered">Application Settings</h1>
            <p class="subtitle is-6 has-text-centered has-text-grey-light mb-5">Configure LLM connection, OCR method, and default AI prompts.</p>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="notification is-{{ 'success' if category == 'success' else 'danger' }} is-light is-small mb-4">
                            <button class="delete is-small"></button>
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" action="{{ url_for('settings.manage_settings') }}">
                <h2 class="title is-5">LLM Configuration</h2>
                <div class="field">
                    <label class="label" for="llm_server_url">LLM Server URL</label>
                    <div class="control has-icons-left">
                        <input class="input" type="url" id="llm_server_url" name="llm_server_url" value="{{ settings.llm_server_url }}" placeholder="e.g. http://localhost:11434/api/generate" required>
                        <span class="icon is-small is-left"><i class="fas fa-server"></i></span>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="llm_model_name">LLM Model Name</label>
                    <div class="control has-icons-left">
                        <input class="input" type="text" id="llm_model_name" name="llm_model_name" value="{{ settings.llm_model_name }}" placeholder="e.g. llama3.1:8b" required>
                         <span class="icon is-small is-left"><i class="fas fa-brain"></i></span>
                    </div>
                </div>
                
                <hr>
                <h2 class="title is-5 mt-5">OCR Configuration</h2>
                <div class="field">
                    <label class="label">OCR Mode</label>
                    <div class="control">
                        <label class="radio">
                            <input type="radio" name="ocr_mode" value="local" id="ocr_mode_local" {% if settings.ocr_mode == 'local' %}checked{% endif %}>
                            Local OCR (EasyOCR)
                        </label>
                        <div class="ocr-mode-info">Process images locally using EasyOCR. Requires no additional setup but uses local processing power.</div>
                    </div>
                    <div class="control mt-3">
                        <label class="radio">
                            <input type="radio" name="ocr_mode" value="remote" id="ocr_mode_remote" {% if settings.ocr_mode == 'remote' %}checked{% endif %}>
                            Remote OCR Server
                        </label>
                        <div class="ocr-mode-info">Send images to a remote OCR server for processing. Useful for offloading processing or centralizing OCR.</div>
                    </div>
                </div>

                <div class="ocr-server-settings" id="ocr-server-settings">
                    <div class="field">
                        <label class="label" for="ocr_server_url">OCR Server URL</label>
                        <div class="control has-icons-left">
                            <input class="input" type="url" id="ocr_server_url" name="ocr_server_url" value="{{ settings.ocr_server_url }}" placeholder="e.g. http://192.168.1.100:8080/ocr">
                            <span class="icon is-small is-left"><i class="fas fa-server"></i></span>
                        </div>
                        <p class="help">The URL endpoint where images will be sent for OCR processing.</p>
                    </div>
                </div>
                
                <hr>
                <h2 class="title is-5 mt-5">Default Prompt Templates</h2>
                <p class="is-size-7 has-text-grey-light mb-4">Edit the default prompts used for various AI actions. The AI will append the relevant text to these templates.</p>

                {% for key in default_prompt_keys %}
                <div class="field mb-5">
                    <label class="label" for="prompt_{{key}}">{{ key.replace('_', ' ') | title }}</label>
                    <div class="control">
                        <textarea id="prompt_{{key}}" name="prompt_{{key}}" class="textarea prompt-textarea" rows="6">{{ settings.prompts.get(key, '') }}</textarea>
                    </div>
                </div>
                {% endfor %}

                <div class="field mt-6">
                    <div class="control">
                        <button type="submit" class="button is-primary is-fullwidth is-medium">
                            <span class="icon"><i class="fas fa-save"></i></span>
                            <span>Save All Settings</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Handle OCR mode switching
    const ocrModeLocal = document.getElementById('ocr_mode_local');
    const ocrModeRemote = document.getElementById('ocr_mode_remote');
    const ocrServerSettings = document.getElementById('ocr-server-settings');
    
    function updateOcrSettings() {
        if (ocrModeRemote.checked) {
            ocrServerSettings.classList.add('visible');
            document.getElementById('ocr_server_url').required = true;
        } else {
            ocrServerSettings.classList.remove('visible');
            document.getElementById('ocr_server_url').required = false;
        }
    }
    
    // Set initial state
    updateOcrSettings();
    
    // Add event listeners
    ocrModeLocal.addEventListener('change', updateOcrSettings);
    ocrModeRemote.addEventListener('change', updateOcrSettings);
    
    // Update radio button styling on change
    function updateRadioStyles() {
        document.querySelectorAll('.radio').forEach(label => {
            const radio = label.querySelector('input[type="radio"]');
            if (radio && radio.checked) {
                label.style.background = '#2a2a2a';
                label.style.borderColor = '#ff6600';
                label.style.color = '#ff6600';
            } else {
                label.style.background = '#1e1e1e';
                label.style.borderColor = '#333';
                label.style.color = '#e0e0e0';
            }
        });
    }
    
    // Set initial radio styling
    updateRadioStyles();
    
    // Add listeners for all radio buttons
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', updateRadioStyles);
    });
});
</script>
{% endblock %}