{% extends "base.html" %}
{% block title %}Upload & Process Image{% endblock %}

{% block head %}
{{ super() }}
<style>
    .upload-page-container {
        max-width: 600px;
        margin: 3rem auto;
    }
    .camera-feed {
        max-width: 100%;
        height: auto;
        border: 1px solid #4a4a4a;
        margin-bottom: 1rem;
        border-radius: 4px;
        background-color: #2c2c2c;
        min-height: 240px;
    }
    .file-label .file-name {
        border-width: 1px;
    }
    .button.is-loading::after {
        border-color: transparent transparent #fff #fff !important;
    }
    #rpi-camera-section .subtitle,
    #rpi-camera-section-unavailable .subtitle {
        min-height: 2.5em;
        padding-bottom: 0.5rem;
    }
    .camera-feed-container {
        position: relative;
        display: none;
        justify-content: center;
        align-items: center;
        background: #232323;
        border-radius: 16px;
        border: 1.5px solid #333;
        box-shadow: 0 2px 12px 0 rgba(0,0,0,0.10);
        margin: 0 auto 1.5em auto;
        padding: 0.5em;
        width: auto;
        min-width: 0;
        min-height: 0;
        max-width: 100%;
        max-height: 70vh;
    }
    .camera-feed-container.visible {
        display: flex;
    }
    .camera-feed {
        display: none;
        max-width: 100%;
        max-height: 60vh;
        width: auto;
        height: auto;
        border-radius: 12px;
        object-fit: contain;
        background: #181818;
        box-shadow: 0 2px 8px 0 rgba(0,0,0,0.10);
        transition: transform 0.3s;
    }
    .camera-feed.visible {
        display: block;
    }
    .camera-feed.portrait {
        transform: rotate(90deg);
        max-width: 60vh;
        max-height: 100vw;
    }
    .camera-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(18, 18, 18, 0.9);
        color: #9a9a9a;
        font-style: italic;
        z-index: 10;
        border-radius: 12px;
    }
    .capture-processing-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(18, 18, 18, 0.95);
        color: #ff6600;
        z-index: 20;
        border-radius: 12px;
    }
    .capture-processing-overlay.active {
        display: flex;
    }
    .capture-processing-overlay .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #333;
        border-top-color: #ff6600;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .capture-processing-overlay .processing-text {
        font-size: 1.1rem;
        font-weight: 500;
        text-align: center;
        padding: 0 2rem;
    }
    .button.upload-flat {
        background: #ff8800;
        color: #fff;
        border: none;
        border-radius: 8px;
        box-shadow: none;
        font-weight: 600;
        font-size: 1.1rem;
        padding: 0.9em 0;
        transition: background 0.2s, box-shadow 0.2s;
        margin-top: 1.2em;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 100%;
        text-align: center;
        gap: 0.7em;
        letter-spacing: 0.01em;
    }
    .button.upload-flat:hover:not(:disabled), .button.upload-flat:focus:not(:disabled) {
        background: #ff6a00;
        color: #fff;
        box-shadow: 0 2px 8px 0 rgba(255,136,0,0.10);
    }
    .button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .autofocus-controls {
        display: flex;
        gap: 1em;
        justify-content: center;
        align-items: center;
        margin-bottom: 1em;
    }
    .autofocus-status {
        font-size: 0.95em;
        color: #6ee7b7;
        margin-left: 0.5em;
    }
    .upload-box-label {
        color: #e0e0e0;
        font-weight: 600;
        margin-bottom: 0.5em;
        display: block;
        text-align: left;
    }
    .button-main {
        background: #ff8800;
        color: #fff;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1.08em;
        padding: 0.85em 0;
        width: 100%;
        max-width: 100%;
        min-width: 200px;
        min-height: 2.8em;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.7em;
        box-shadow: 0 2px 8px 0 rgba(255,136,0,0.10);
        transition: background 0.2s, color 0.2s, box-shadow 0.2s, opacity 0.2s;
        margin-bottom: 1em;
        letter-spacing: 0.01em;
    }
    .button-main:hover:not(:disabled), .button-main:focus:not(:disabled) {
        background: #ff6a00;
        color: #fff;
        box-shadow: 0 2px 12px 0 rgba(255,136,0,0.18);
    }
    .button-main:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #4a4a4a;
        color: #888;
    }
    .file-input {
        display: none;
    }
    .file-name {
        color: #e0e0e0;
        background: #181818;
        border: 1.5px solid #333;
        border-radius: 12px;
        padding: 0.85em 1.2em;
        width: 100%;
        text-align: center;
        font-size: 1.08em;
        margin-bottom: 1.2em;
        margin-top: 0;
        box-sizing: border-box;
        min-height: 2.8em;
        display: flex;
        align-items: center;
        justify-content: center;
        letter-spacing: 0.01em;
        box-shadow: 0 2px 8px 0 rgba(0,0,0,0.10);
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .file-name.has-file {
        border-color: #ff6600;
        color: #ff6600;
        background: #1e1e1e;
    }
    .box#upload-box {
        background: #181818;
        border-radius: 14px;
        box-shadow: 0 2px 12px 0 rgba(0,0,0,0.12);
        padding: 2.5em 2em 2em 2em;
    }
    .box#upload-box h1,
    .box#upload-box p,
    .box#upload-box label,
    .box#upload-box .file-name {
        color: #e0e0e0;
    }
    .upload-page-container form .field {
        margin-bottom: 0.5em;
    }
    .autofocus-controls button#toggle-af-btn.autofocus-on {
        background: #10b981;
        color: #fff;
        border: none;
        box-shadow: 0 2px 8px 0 rgba(16,185,129,0.10);
    }
    .autofocus-controls button#toggle-af-btn.autofocus-off {
        background: #232323;
        color: #e0e0e0;
        border: none;
        box-shadow: 0 2px 8px 0 rgba(0,0,0,0.10);
    }
    .autofocus-controls button#toggle-af-btn {
        transition: background 0.2s, color 0.2s;
    }
    .camera-frozen-indicator {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(255, 102, 0, 0.9);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-weight: 600;
        display: none;
        z-index: 15;
    }
    .camera-frozen-indicator.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<section class="section">
    <div class="container upload-page-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="notification is-{{ 'danger' if category == 'error' else category }} is-light is-small mb-4" id="flash-message-{{ loop.index }}">
                        <button class="delete is-small" onclick="this.parentElement.remove();"></button>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="box" id="upload-box">
            <h1 class="title is-3 has-text-centered">Process New Image</h1>
            <p class="subtitle is-6 has-text-centered has-text-grey-light mb-5">Upload an image file (PNG, JPG, WEBP) to extract text.</p>
            
            <form method="POST" action="{{ url_for('main.process_upload') }}" enctype="multipart/form-data" id="upload-form">
                <div class="field">
                    <label class="upload-box-label" for="file-upload-input">Image File</label>
                    <label class="button-main" tabindex="0" id="file-select-button">
                        <span class="file-icon"><i class="fas fa-upload"></i></span>
                        <span class="file-label">Choose a file...</span>
                        <input class="file-input" type="file" name="file" accept="image/png, image/jpeg, image/webp" id="file-upload-input">
                    </label>
                    <span class="file-name" id="file-name-display">No file selected</span>
                </div>
                <div id="upload-form-error-placeholder" class="mt-2"></div>
                <div class="field mt-5">
                    <div class="control has-text-centered">
                        <button type="submit" class="button-main" id="upload-submit-button" disabled>
                            <span class="icon"><i class="fas fa-cogs"></i></span>
                            <span>Upload and Process</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        {% if camera_available %}
        <div class="box mt-5" id="rpi-camera-section">
            <h2 class="title is-4 has-text-centered">RPi Camera</h2>
            <p class="subtitle is-6 has-text-centered has-text-grey-light mb-4" id="camera-status-text">Checking camera status...</p>
            <div class="has-text-centered mb-3 autofocus-controls">
                <button class="button is-small is-rounded" id="toggle-portrait-btn" type="button" disabled>
                    <span class="icon"><i class="fas fa-mobile-alt"></i></span>
                    <span id="portrait-btn-label">Portrait Mode: Off</span>
                </button>
                <button class="button is-small is-rounded autofocus-off" id="toggle-af-btn" type="button" disabled>
                    <span class="icon"><i class="fas fa-bullseye"></i></span>
                    <span id="af-btn-label">Autofocus: ...</span>
                </button>
                <button class="button is-small is-rounded" id="oneshot-af-btn" type="button" disabled>
                    <span class="icon"><i class="fas fa-crosshairs"></i></span>
                    <span>One-Shot AF</span>
                </button>
                <span class="autofocus-status" id="af-status"></span>
            </div>
            <div class="has-text-centered camera-feed-container" id="camera-feed-container">
                 <img src="" alt="Camera Feed" id="camera-feed-img" class="camera-feed"/>
                 <div class="camera-loading-overlay" id="camera-loading-overlay" style="display: none;">Loading camera...</div>
                 <div class="capture-processing-overlay" id="capture-processing-overlay">
                     <div class="spinner"></div>
                     <div class="processing-text">Processing photo...</div>
                 </div>
                 <div class="camera-frozen-indicator" id="camera-frozen-indicator">
                     <i class="fas fa-pause"></i> Frame Captured
                 </div>
            </div>
            <button class="button-main mb-2 mt-4" id="start-camera-btn" disabled>
                <span class="icon"><i class="fas fa-video"></i></span>
                <span>Start Camera</span>
            </button>
            <button class="button-main mb-2 mt-4" id="stop-camera-btn" style="display:none;">
                <span class="icon"><i class="fas fa-video-slash"></i></span>
                <span>Stop Camera</span>
            </button>
            <button class="button-main" id="capture-photo-btn" style="display:none;" disabled>
                <span class="icon"><i class="fas fa-camera"></i></span>
                <span>Capture Photo & Process</span>
            </button>
            <div id="capture-message-placeholder" class="mt-3"></div>
        </div>
        {% else %}
        <div class="box mt-5 is-hidden-touch" id="rpi-camera-section-unavailable">
             <h2 class="title is-4 has-text-centered">RPi Camera</h2>
             <p class="subtitle is-6 has-text-centered has-text-grey-light mb-4">RPi Camera feature is not available on this device or the camera is not detected.</p>
             <div class="has-text-centered">
                <span class="icon is-large has-text-grey-light"><i class="fas fa-exclamation-triangle fa-3x"></i></span>
             </div>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('file-upload-input');
    const fileNameDisplay = document.getElementById('file-name-display');
    const fileSelectButton = document.getElementById('file-select-button');
    const uploadSubmitButton = document.getElementById('upload-submit-button');
    
    if (fileInput && fileNameDisplay) {
        fileInput.onchange = () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
                fileNameDisplay.classList.add('has-file');
                if (uploadSubmitButton) {
                    uploadSubmitButton.disabled = false;
                }
            } else {
                fileNameDisplay.textContent = "No file selected";
                fileNameDisplay.classList.remove('has-file');
                if (uploadSubmitButton) {
                    uploadSubmitButton.disabled = true;
                }
            }
        }
    }
    
    // Initialize submit button state
    if (uploadSubmitButton) {
        uploadSubmitButton.disabled = true;
    }

    const uploadForm = document.getElementById('upload-form');
    const uploadSubmitButton = document.getElementById('upload-submit-button');
    const uploadFormErrorPlaceholder = document.getElementById('upload-form-error-placeholder');

    if (uploadForm && uploadSubmitButton) {
        uploadForm.addEventListener('submit', (event) => {
            if (fileInput && fileInput.files.length === 0) {
                event.preventDefault();
                displayNotification('Please select a file to upload.', 'warning', uploadFormErrorPlaceholder, true);
                return;
            }
            uploadSubmitButton.classList.add('is-loading');
            uploadSubmitButton.disabled = true;
        });
    }

    function displayNotification(message, type = 'info', container, isFormError = false) {
        if (!container) {
            console.warn("Notification container not found for message:", message);
            if(!isFormError) alert(message);
            return;
        }
        let notificationDiv = container.querySelector('.notification');
        if (!notificationDiv || !isFormError) {
            if(isFormError) container.innerHTML = '';
            notificationDiv = document.createElement('div');
            notificationDiv.className = `notification is-${type} is-light is-small mb-3`;
            container.appendChild(notificationDiv);
        } else {
             notificationDiv.className = `notification is-${type} is-light is-small mb-3`;
        }
        
        notificationDiv.innerHTML = `<button class="delete is-small"></button>${message}`;
        const deleteButton = notificationDiv.querySelector('.delete');
        if (deleteButton) {
            deleteButton.addEventListener('click', () => notificationDiv.remove());
        }
    }

    const cameraSection = document.getElementById('rpi-camera-section');
    if (cameraSection) {
        const cameraFeedImg = document.getElementById('camera-feed-img');
        const cameraFeedContainer = document.getElementById('camera-feed-container');
        const cameraLoadingOverlay = document.getElementById('camera-loading-overlay');
        const captureProcessingOverlay = document.getElementById('capture-processing-overlay');
        const cameraFrozenIndicator = document.getElementById('camera-frozen-indicator');
        const startCameraButton = document.getElementById('start-camera-btn');
        const stopCameraButton = document.getElementById('stop-camera-btn');
        const capturePhotoButton = document.getElementById('capture-photo-btn');
        const cameraStatusText = document.getElementById('camera-status-text');
        const captureMessagePlaceholder = document.getElementById('capture-message-placeholder');
        const togglePortraitBtn = document.getElementById('toggle-portrait-btn');
        const portraitBtnLabel = document.getElementById('portrait-btn-label');
        const toggleAfBtn = document.getElementById('toggle-af-btn');
        const afBtnLabel = document.getElementById('af-btn-label');
        const oneshotAfBtn = document.getElementById('oneshot-af-btn');
        const afStatus = document.getElementById('af-status');
        let portraitMode = false;
        let afEnabled = false;
        let streamActive = false;
        let captureInProgress = false;
        let frozenFrame = null;

        function updatePortraitButton() {
            const img = cameraFeedImg;
            const container = cameraFeedContainer;
            if (portraitMode) {
                portraitBtnLabel.textContent = 'Portrait Mode: On';
                img.classList.add('portrait');
            } else {
                portraitBtnLabel.textContent = 'Portrait Mode: Off';
                img.classList.remove('portrait');
            }
            setTimeout(() => {
                if (img.offsetParent === null || img.naturalWidth === 0 || img.naturalHeight === 0) {
                    container.style.width = 'auto';
                    container.style.height = 'auto';
                    return;
                }
                let imgW = img.naturalWidth;
                let imgH = img.naturalHeight;
                if (portraitMode) {
                    [imgW, imgH] = [imgH, imgW];
                }
                const parentW = container.parentElement.clientWidth;
                const maxH = window.innerHeight * 0.7;
                let scale = Math.min(parentW / imgW, maxH / imgH, 1);
                let targetW = Math.round(imgW * scale);
                let targetH = Math.round(imgH * scale);
                container.style.width = `${targetW}px`;
                container.style.height = `${targetH}px`;
            }, 100);
        }

        togglePortraitBtn.addEventListener('click', async () => {
            if (captureInProgress) return;
            portraitMode = !portraitMode;
            updatePortraitButton();
            try {
                await fetchWithTimeout("{{ url_for('main.toggle_camera_orientation') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: portraitMode })
                });
            } catch (e) {
                displayNotification('Failed to toggle portrait mode.', 'danger', captureMessagePlaceholder);
            }
            if (streamActive && !captureInProgress) {
                showLiveFeed();
            }
        });

        // Helper function for fetch with timeout
        async function fetchWithTimeout(url, options = {}, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        function showCameraLoading(text = "Loading camera...") {
            cameraFeedContainer.classList.remove('visible');
            cameraFeedImg.classList.remove('visible');
            cameraFeedImg.src = '';
            cameraLoadingOverlay.textContent = text;
            cameraLoadingOverlay.style.display = 'flex';
            captureProcessingOverlay.classList.remove('active');
            cameraFrozenIndicator.classList.remove('active');
        }

        function showCameraPlaceholder() {
            cameraFeedContainer.classList.remove('visible');
            cameraFeedImg.classList.remove('visible');
            cameraFeedImg.src = '';
            cameraLoadingOverlay.style.display = 'none';
            captureProcessingOverlay.classList.remove('active');
            cameraFrozenIndicator.classList.remove('active');
        }

        function freezeFrame() {
            // Create a canvas to capture the current frame
            const canvas = document.createElement('canvas');
            canvas.width = cameraFeedImg.naturalWidth;
            canvas.height = cameraFeedImg.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(cameraFeedImg, 0, 0);
            frozenFrame = canvas.toDataURL('image/jpeg');
            
            // Set the frozen frame as the image source
            cameraFeedImg.src = frozenFrame;
            cameraFrozenIndicator.classList.add('active');
        }

        function unfreezeFrame() {
            if (streamActive && !captureInProgress) {
                showLiveFeed();
            }
            cameraFrozenIndicator.classList.remove('active');
            frozenFrame = null;
        }

        function showLiveFeed() {
            if (!cameraFeedImg || !cameraFeedContainer || !cameraLoadingOverlay) return;
            if (captureInProgress) return; // Don't restart feed during capture

            cameraFeedContainer.classList.add('visible');
            cameraFeedImg.classList.remove('visible');
            cameraLoadingOverlay.style.display = 'flex';
            cameraFeedImg.src = '';

            const feedUrl = "{{ url_for('main.camera_feed') }}?_nocache=" + new Date().getTime();
            cameraFeedImg.src = feedUrl;

            cameraFeedImg.onload = () => {
                console.log("camera_feed_img loaded. Dimensions:", cameraFeedImg.offsetWidth, cameraFeedImg.offsetHeight);
                cameraFeedImg.classList.add('visible');
                cameraLoadingOverlay.style.display = 'none';
                updatePortraitButton();
            };

            cameraFeedImg.onerror = () => {
                console.error("Failed to load camera feed from URL:", feedUrl);
                cameraLoadingOverlay.textContent = 'Error loading feed.';
                cameraFeedImg.classList.remove('visible');
            };
        }

        async function checkCameraStatus() {
            showCameraLoading("Checking camera status...");
            startCameraButton.disabled = true;
            capturePhotoButton.disabled = true;
            togglePortraitBtn.disabled = true;
            toggleAfBtn.disabled = true;
            oneshotAfBtn.disabled = true;

            try {
                const response = await fetchWithTimeout("{{ url_for('main.camera_status') }}");
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (data.available) {
                    startCameraButton.disabled = false; 
                    if (data.streaming) {
                        activateStreamUI();
                        cameraStatusText.textContent = "Camera live."; 
                    } else {
                        deactivateStreamUI("Camera ready. Press Start.", false);
                    }
                } else {
                    cameraStatusText.textContent = data.message || "RPi Camera not available.";
                    deactivateStreamUI(data.message || "RPi Camera not available.", true);
                }
            } catch (error) {
                console.error("Error checking camera status:", error);
                let errorMsg = "Camera status check failed.";
                if (error.name === 'AbortError') {
                    errorMsg = "Camera status check timed out.";
                } else if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
                    errorMsg = "Network error checking camera.";
                } else if (error.message.includes('HTTP')) {
                    errorMsg = `Server error: ${error.message}`;
                }
                deactivateStreamUI(errorMsg, true);
            }
        }

        function activateStreamUI() {
            if (!captureInProgress) {
                showLiveFeed();
            }
            startCameraButton.style.display = 'none';
            stopCameraButton.style.display = 'block';
            stopCameraButton.disabled = captureInProgress;
            
            capturePhotoButton.style.display = 'block';
            capturePhotoButton.disabled = captureInProgress;
            togglePortraitBtn.disabled = captureInProgress;
            oneshotAfBtn.disabled = captureInProgress;
            
            cameraStatusText.textContent = "Camera live.";
            streamActive = true;
            setTimeout(updateAfStateUI, 500);
        }

        function deactivateStreamUI(statusText = "Camera stopped.", disableAll = true) {
            showCameraPlaceholder();
            startCameraButton.style.display = 'block';
            startCameraButton.disabled = disableAll || captureInProgress;

            stopCameraButton.style.display = 'none';
            capturePhotoButton.style.display = 'none';
            
            capturePhotoButton.disabled = true;
            togglePortraitBtn.disabled = true;
            toggleAfBtn.disabled = true;
            oneshotAfBtn.disabled = true;
            
            cameraStatusText.textContent = statusText;
            streamActive = false;
            captureInProgress = false;
            if (disableAll) {
                updateAfStateUI();
            }
        }

        function disableAllControls() {
            startCameraButton.disabled = true;
            stopCameraButton.disabled = true;
            capturePhotoButton.disabled = true;
            togglePortraitBtn.disabled = true;
            toggleAfBtn.disabled = true;
            oneshotAfBtn.disabled = true;
        }

        function enableControlsAfterCapture() {
            if (streamActive) {
                stopCameraButton.disabled = false;
                capturePhotoButton.disabled = false;
                togglePortraitBtn.disabled = false;
                toggleAfBtn.disabled = false;
                oneshotAfBtn.disabled = false;
            } else {
                startCameraButton.disabled = false;
            }
        }

        startCameraButton.addEventListener('click', async () => {
            startCameraButton.classList.add('is-loading');
            disableAllControls();
            showCameraLoading("Starting camera...");
            
            try {
                const response = await fetchWithTimeout("{{ url_for('main.start_camera_stream') }}", { method: 'POST' });
                const result = await response.json();
                if (response.ok && result.success) {
                    activateStreamUI();
                } else {
                    const errorMsg = "Failed to start camera: " + (result.error || "Unknown error");
                    deactivateStreamUI(errorMsg);
                    displayNotification(errorMsg, 'danger', captureMessagePlaceholder);
                }
            } catch (error) {
                console.error("Error starting camera:", error);
                const errorMsg = "Error starting camera: " + error.message;
                deactivateStreamUI(errorMsg);
                displayNotification(errorMsg, 'danger', captureMessagePlaceholder);
            }
            startCameraButton.classList.remove('is-loading');
            if (!streamActive && !startCameraButton.disabled) {
                startCameraButton.disabled = false;
            }
        });

        stopCameraButton.addEventListener('click', async () => {
            if (captureInProgress) return;
            
            stopCameraButton.classList.add('is-loading');
            disableAllControls();
            showCameraLoading("Stopping camera...");
            
            try {
                const response = await fetchWithTimeout("{{ url_for('main.stop_camera_stream') }}", { method: 'POST' });
                const result = await response.json();
                if (response.ok && result.success) {
                    deactivateStreamUI("Camera stopped. Press Start to resume.", false);
                } else {
                    const errorMsg = "Failed to stop camera: " + (result.error || "Unknown error");
                    cameraStatusText.textContent = errorMsg;
                    displayNotification(errorMsg, 'danger', captureMessagePlaceholder);
                    stopCameraButton.disabled = false; 
                    if(streamActive) {
                        activateStreamUI();
                    } else {
                        deactivateStreamUI(errorMsg, true);
                    }
                }
            } catch (error) {
                console.error("Error stopping camera:", error);
                const errorMsg = "Error stopping camera: " + error.message;
                cameraStatusText.textContent = errorMsg;
                displayNotification(errorMsg, 'danger', captureMessagePlaceholder);
                stopCameraButton.disabled = false; 
                if(streamActive) {
                    activateStreamUI();
                } else {
                    deactivateStreamUI(errorMsg, true);
                }
            }
            stopCameraButton.classList.remove('is-loading');
        });

        capturePhotoButton.addEventListener('click', async () => {
            captureInProgress = true;
            capturePhotoButton.classList.add('is-loading');
            disableAllControls();
            
            // Freeze the current frame
            freezeFrame();
            
            // Show processing overlay
            setTimeout(() => {
                captureProcessingOverlay.classList.add('active');
            }, 100);
            
            // Clear previous messages
            if (captureMessagePlaceholder) captureMessagePlaceholder.innerHTML = '';

            try {
                const response = await fetch("{{ url_for('main.capture_rpi_photo') }}", { method: 'POST' });
                const result = await response.json();

                if (response.ok && result.success) {
                    // Update processing text
                    captureProcessingOverlay.querySelector('.processing-text').textContent = 'Success! Redirecting...';
                    
                    if (result.redirect_url) {
                        setTimeout(() => {
                            window.location.href = result.redirect_url;
                        }, 1500);
                    } else if (result.warning) {
                        displayNotification(result.warning, 'warning', captureMessagePlaceholder);
                        captureInProgress = false;
                        captureProcessingOverlay.classList.remove('active');
                        unfreezeFrame();
                        enableControlsAfterCapture();
                    }
                } else {
                    const errorMsg = "Capture/Processing failed: " + (result.error || "Unknown error");
                    displayNotification(errorMsg, 'danger', captureMessagePlaceholder);
                    captureInProgress = false;
                    captureProcessingOverlay.classList.remove('active');
                    unfreezeFrame();
                    enableControlsAfterCapture();
                }
            } catch (error) {
                console.error("Error capturing photo:", error);
                const errorMsg = "Error during capture: " + error.message;
                displayNotification(errorMsg, 'danger', captureMessagePlaceholder);
                captureInProgress = false;
                captureProcessingOverlay.classList.remove('active');
                unfreezeFrame();
                enableControlsAfterCapture();
            }
            
            capturePhotoButton.classList.remove('is-loading');
            
            // Re-check camera status if not redirecting
            if (!result || !result.redirect_url) {
                setTimeout(() => {
                    if (!captureInProgress) {
                        checkCameraStatus();
                    }
                }, 500);
            }
        });

        function updateAfStateUI() {
            if (!toggleAfBtn) return;
            afBtnLabel.textContent = afEnabled ? 'Autofocus: On' : 'Autofocus: Off';
            toggleAfBtn.classList.toggle('autofocus-on', afEnabled);
            toggleAfBtn.classList.toggle('autofocus-off', !afEnabled);
            afStatus.textContent = '';
            toggleAfBtn.disabled = !streamActive || captureInProgress;
        }

        toggleAfBtn.addEventListener('click', async () => {
            if (!streamActive || captureInProgress) {
                displayNotification("Cannot toggle autofocus right now.", "warning", captureMessagePlaceholder);
                return;
            }
            afEnabled = !afEnabled;
            updateAfStateUI();
            afBtnLabel.textContent = afEnabled ? 'AF: Enabling...' : 'AF: Disabling...';
            toggleAfBtn.disabled = true;
            toggleAfBtn.classList.add('is-loading');
            try {
                await fetchWithTimeout("{{ url_for('main.camera_set_autofocus') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: afEnabled })
                });
            } catch (e) {
                displayNotification('Error sending autofocus command.', 'danger', captureMessagePlaceholder);
            } finally {
                setTimeout(() => {
                    toggleAfBtn.classList.remove('is-loading');
                    updateAfStateUI();
                }, 800);
            }
        });

        oneshotAfBtn.addEventListener('click', async () => {
            if (!streamActive || captureInProgress) {
                displayNotification("Cannot trigger autofocus right now.", "warning", captureMessagePlaceholder);
                return;
            }
            oneshotAfBtn.classList.add('is-loading');
            oneshotAfBtn.disabled = true;
            toggleAfBtn.disabled = true;
            await fetchWithTimeout("{{ url_for('main.camera_trigger_autofocus') }}", { method: 'POST' });
            setTimeout(() => {
                oneshotAfBtn.classList.remove('is-loading');
                oneshotAfBtn.disabled = false;
                toggleAfBtn.disabled = false;
                updateAfStateUI();
            }, 1200);
        });

        checkCameraStatus();
    }

    document.querySelectorAll('.notification .delete').forEach((deleteButton) => {
        if (!deleteButton.dataset.listenerAttached) {
            deleteButton.addEventListener('click', () => {
                deleteButton.parentElement.remove();
            });
            deleteButton.dataset.listenerAttached = 'true';
        }
    });
});
</script>
{% endblock %}