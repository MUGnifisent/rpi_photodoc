{% extends "base.html" %}
{% block title %}My Documents{% endblock %}

{% block head %}
<style>
    .document-card {
        margin-bottom: 1.5rem;
        word-break: break-word; /* Prevent long names from breaking layout */
    }
    .document-card .card-image .image img {
        max-height: 200px; /* Control image height in card */
        object-fit: cover; /* Ensure image covers the area, might crop */
        border-bottom: 1px solid #363636;
    }
    .document-card .card-content {
        padding: 1rem;
    }
    .document-card .media-content .title {
        font-size: 1.25rem; /* Smaller title for cards */
        margin-bottom: 0.5rem;
    }
    .document-card .media-content .subtitle {
        font-size: 0.85rem;
    }
    .actions .button {
        margin-right: 0.5rem;
    }
    .no-documents {
        text-align: center;
        padding: 3rem;
        border: 2px dashed #4a4a4a;
        border-radius: 6px;
    }
</style>
{% endblock %}

{% block content %}
<nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
        <a class="navbar-item" href="{{ url_for('main.index') }}">
            <h1 class="title is-4 has-text-primary"><i class="fas fa-robot mr-2"></i>RPi OCR Formatter</h1>
        </a>
        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarMain">
            <span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span>
        </a>
    </div>
    <div id="navbarMain" class="navbar-menu">
        <div class="navbar-start">
            <a class="navbar-item" href="{{ url_for('main.upload_page') }}">
                <span class="icon"><i class="fas fa-upload"></i></span>
                <span>Upload New</span>
            </a>
            <a class="navbar-item is-active" href="{{ url_for('main.gallery_view') }}">
                 <span class="icon"><i class="fas fa-images"></i></span>
                <span>My Documents</span>
            </a>
            <a class="navbar-item" href="{{ url_for('settings.manage_settings') }}">
                 <span class="icon"><i class="fas fa-cog"></i></span>
                <span>Settings</span>
            </a>
        </div>
        <div class="navbar-end">
            <div class="navbar-item">
                <div class="buttons">
                    {% if current_user.is_authenticated %}
                        <span class="navbar-item">Hi, <strong>{{ current_user.username }}</strong>!</span>
                        <a href="{{ url_for('main.logout') }}" class="button is-primary">
                            <span class="icon"><i class="fas fa-sign-out-alt"></i></span>
                            <span>Logout</span>
                        </a>
                    {% else %}
                        <a href="{{ url_for('main.register') }}" class="button is-primary">
                            <strong>Sign up</strong>
                        </a>
                        <a href="{{ url_for('main.login') }}" class="button is-light">
                            Log in
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</nav>

<section class="section" style="padding-top: 6rem;">
    <div class="container">
        <div class="level">
            <div class="level-left">
                <h1 class="title">My Processed Documents</h1>
            </div>
            <div class="level-right">
                <a href="{{ url_for('main.upload_page') }}" class="button is-primary">
                    <span class="icon"><i class="fas fa-plus"></i></span>
                    <span>Process New Image</span>
                </a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="notification is-{{ 'danger' if category == 'error' else category }} is-light">
                        <button class="delete"></button>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if documents %}
            <div class="columns is-multiline">
                {% for doc in documents %}
                    <div class="column is-one-third">
                        <div class="card document-card">
                            {% if doc.pages and doc.pages[0].image_filename %}
                            <div class="card-image">
                                <figure class="image is-4by3">
                                    <img src="{{ url_for('static', filename='../uploads/' + doc.pages[0].image_filename) }}" alt="{{ doc.name }}">
                                </figure>
                            </div>
                            {% endif %}
                            <div class="card-content">
                                <div class="media">
                                    <div class="media-content">
                                        <p class="title is-5">{{ doc.name }}</p>
                                        <p class="subtitle is-7">Last updated: {{ doc.updated_at | format_datetime if doc.updated_at else doc.created_at | format_datetime }}</p>
                                        <p class="subtitle is-7">Pages: {{ doc.pages | length }}</p>
                                    </div>
                                </div>
                                <div class="content is-small">
                                   Preview: {{ doc.pages[0].edited_text[:100] if doc.pages and doc.pages[0].edited_text else 'No text preview available' }}...
                                </div>
                            </div>
                            <footer class="card-footer">
                                <a href="{{ url_for('main.document_view', doc_id=doc.id) }}" class="card-footer-item">
                                    <span class="icon"><i class="fas fa-eye"></i></span>View/Edit
                                </a>
                                <form action="{{ url_for('main.delete_document_route', doc_id=doc.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this document?');">
                                    <button type="submit" class="card-footer-item button is-danger is-text">
                                         <span class="icon"><i class="fas fa-trash-alt"></i></span>Delete
                                    </button>
                                </form>
                            </footer>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-documents">
                <p class="title is-4">No documents yet!</p>
                <p class="subtitle is-6">Upload an image to get started.</p>
                <a href="{{ url_for('main.upload_page') }}" class="button is-primary is-medium mt-4">
                    <span class="icon"><i class="fas fa-upload"></i></span>
                    <span>Upload First Image</span>
                </a>
            </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Navbar burger
    const navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
    if (navbarBurgers.length > 0) {
        navbarBurgers.forEach(el => {
            el.addEventListener('click', () => {
                const target = el.dataset.target;
                const $target = document.getElementById(target);
                el.classList.toggle('is-active');
                $target.classList.toggle('is-active');
            });
        });
    }

    // Dismiss notifications
    (document.querySelectorAll('.notification .delete') || []).forEach(($delete) => {
        const $notification = $delete.parentNode;
        $delete.addEventListener('click', () => {
            $notification.parentNode.removeChild($notification);
        });
    });
});
</script>
<script defer src="https://use.fontawesome.com/releases/v5.15.4/js/all.js"></script>
{% endblock %} 